# РўРѕС‡РєРё РІРµР±С…СѓРєРѕРІ РґР»СЏ РЎСѓРґР°

Р”РѕРєСѓРјРµРЅС‚ РѕРїРёСЃС‹РІР°РµС‚, РєР°Рє РЅР°СЃС‚СЂРѕРёС‚СЊ Рё СЌРєСЃРїР»СѓР°С‚РёСЂРѕРІР°С‚СЊ РІРµР±С…СѓРєРё РІ СЂР°Р·РґРµР»Рµ **Admin в†’ Social Profile в†’ Court в†’ Settings в†’ РўРѕС‡РєРё РІРµР±С…СѓРєРѕРІ**. Р­С‚Р° СЃС‚СЂР°РЅРёС†Р° РґРѕРїРѕР»РЅСЏРµС‚ РєСЂР°С‚РєРёРµ Р·Р°РјРµС‚РєРё РёР· `docs/USAGE-court.md` Рё РїСЂРµРґРЅР°Р·РЅР°С‡РµРЅР° РґР»СЏ С‚РµС…, РєС‚Рѕ РїРѕРґРєР»СЋС‡Р°РµС‚ РІРЅРµС€РЅРёРµ РёРЅС‚РµРіСЂР°С†РёРё РёР»Рё СЃР»РµРґРёС‚ Р·Р° РґРѕСЃС‚Р°РІРєРѕР№ СѓРІРµРґРѕРјР»РµРЅРёР№.

## Р”РѕСЃС‚СѓРї Рё РЅР°РІРёРіР°С†РёСЏ
- РџСЂР°РІР°: `social.court.webhooks` (СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёРµ СЃРїРёСЃРєР° С‚РѕС‡РµРє) Рё `social.court.manage_settings` (РґРѕСЃС‚СѓРї Рє РѕСЃС‚Р°Р»СЊРЅС‹Рј РЅР°СЃС‚СЂРѕР№РєР°Рј СЂР°Р·РґРµР»Р°).
- РџСѓС‚СЊ: **Admin в†’ Court в†’ Settings в†’ Р’РµР±С…СѓРєРё**. Р›РµРІР°СЏ РєРѕР»РѕРЅРєР° СЃРѕРґРµСЂР¶РёС‚ РѕР±С‰РёРµ РЅР°СЃС‚СЂРѕР№РєРё СЃСѓРґР°, РїСЂР°РІР°СЏ вЂ” С„РѕСЂРјСѓ СЃРѕР·РґР°РЅРёСЏ С‚РѕС‡РєРё Рё СЃРїРёСЃРѕРє СѓР¶Рµ СЃРѕР·РґР°РЅРЅС‹С….
- РџСЂРё СЃРѕР·РґР°РЅРёРё Р·Р°РїРёСЃРё С„Р»Р°Рі `is_active` РІСЃРµРіРґР° РІРєР»СЋС‡С‘РЅ. РџСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РІСЂРµРјРµРЅРЅРѕ РІС‹РєР»СЋС‡РёС‚СЊ РІРµР±С…СѓРє, СѓРґР°Р»РёС‚Рµ С‚РѕС‡РєСѓ РёР· РёРЅС‚РµСЂС„РµР№СЃР° РёР»Рё РѕР±РЅРѕРІРёС‚Рµ Р·Р°РїРёСЃСЊ РЅР°РїСЂСЏРјСѓСЋ РІ Р‘Р”.

## РџРѕР»СЏ С‚РѕС‡РєРё
| РџРѕР»Рµ | РќР°Р·РЅР°С‡РµРЅРёРµ |
|------|------------|
| `РќР°Р·РІР°РЅРёРµ` | Р§РµР»РѕРІРµРєРѕС‡РёС‚Р°РµРјС‹Р№ С‚РµРі, РєРѕС‚РѕСЂС‹Р№ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ С‚РѕР»СЊРєРѕ РІРЅСѓС‚СЂРё РїР°РЅРµР»Рё (РІРёРґРµРЅ РІ СЃРїРёСЃРєРµ С‚РѕС‡РµРє Рё Р»РѕРіР°С…). |
| `URL` | РљРѕРЅРµС‡РЅС‹Р№ Р°РґСЂРµСЃ, РєРѕС‚РѕСЂС‹Р№ РїСЂРёРЅРёРјР°РµС‚ `POST`-Р·Р°РїСЂРѕСЃС‹ РІ С„РѕСЂРјР°С‚Рµ JSON. РћР±СЏР·Р°С‚РµР»СЊРЅРѕ РґРѕР»Р¶РЅР° Р±С‹С‚СЊ РїСѓР±Р»РёС‡РЅРѕ РґРѕСЃС‚СѓРїРЅР°СЏ HTTPS-С‚РѕС‡РєР°. |
| `РЎРµРєСЂРµС‚` | РќРµРѕР±СЏР·Р°С‚РµР»СЊРЅР°СЏ СЃС‚СЂРѕРєР° РґРѕ 255 СЃРёРјРІРѕР»РѕРІ. РџСЂРё Р·Р°РїРѕР»РЅРµРЅРёРё СЃРёСЃС‚РµРјР° Р±СѓРґРµС‚ РїРѕРґРїРёСЃС‹РІР°С‚СЊ РєР°Р¶РґСѓСЋ РґРѕСЃС‚Р°РІРєСѓ HMAC-РїРѕРґРїРёСЃСЊСЋ. |
| `РЎРѕР±С‹С‚РёСЏ` | РњРЅРѕР¶РµСЃС‚РІРµРЅРЅС‹Р№ РІС‹Р±РѕСЂ: `issued`, `reverted`, `updated`. РџСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє = РїРѕРґРїРёСЃРєР° РЅР° РІСЃРµ СЃРѕР±С‹С‚РёСЏ. |

> РСЃРїРѕР»СЊР·СѓР№С‚Рµ РѕС‚РґРµР»СЊРЅС‹Рµ URL РґР»СЏ СЂР°Р·РЅС‹С… СЃРёСЃС‚РµРј (Discord-Р±РѕС‚, SIEM, Minecraft-Р°РґР°РїС‚РµСЂ), С‡С‚РѕР±С‹ СѓРїСЂРѕС‰Р°С‚СЊ РѕС‚Р»Р°РґРєСѓ Рё РѕРіСЂР°РЅРёС‡РёРІР°С‚СЊ РїСЂР°РІР° РєР°Р¶РґРѕР№ РёРЅС‚РµРіСЂР°С†РёРё.

## РЎРѕР±С‹С‚РёСЏ
| РЎРѕР±С‹С‚РёРµ | РљРѕРјРјРµРЅС‚Р°СЂРёР№ |
|---------|-------------|
| `issued` | РћС‚РїСЂР°РІР»СЏРµС‚СЃСЏ СЃСЂР°Р·Сѓ РїРѕСЃР»Рµ СЃРѕР·РґР°РЅРёСЏ РґРµР»Р° (`CourtService::storeDecision`). |
| `updated` | Р—Р°СЂРµР·РµСЂРІРёСЂРѕРІР°РЅРѕ РїРѕРґ Р±СѓРґСѓС‰РёРµ РїСЂР°РІРєРё РґРµР» (РЅР°РїСЂРёРјРµСЂ, РїСЂРѕРґР»РµРЅРёРµ РёР»Рё РёР·РјРµРЅРµРЅРёРµ РєРѕРјРјРµРЅС‚Р°СЂРёСЏ). |
| `reverted` | РСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РїСЂРё РѕС‚РєР°С‚Рµ РґРµР№СЃС‚РІРёР№ (РїРѕ СЂР°СЃРїРёСЃР°РЅРёСЋ `socialprofile:court:tick` РёР»Рё РІСЂСѓС‡РЅСѓСЋ). |

Р”Р°Р¶Рµ РµСЃР»Рё РІС‹Р±СЂР°РЅ С‚РѕР»СЊРєРѕ РѕРґРёРЅ С‚РёРї СЃРѕР±С‹С‚РёСЏ, Р·Р°РїРёСЃСЊ РѕСЃС‚Р°С‘С‚СЃСЏ РІ РѕС‡РµСЂРµРґРё РґРѕСЃС‚Р°РІРѕРє вЂ” РѕСЃС‚Р°Р»СЊРЅС‹Рµ С„РёР»СЊС‚СЂСѓСЋС‚СЃСЏ РµС‰С‘ РґРѕ РїРѕСЃС‚Р°РЅРѕРІРєРё РІ РѕС‡РµСЂРµРґСЊ, С‡С‚Рѕ Р·Р°С‰РёС‰Р°РµС‚ РІРЅРµС€РЅРёРµ СЃРёСЃС‚РµРјС‹ РѕС‚ Р»РёС€РЅРёС… РІС‹Р·РѕРІРѕРІ.

## Р¤РѕСЂРјР°С‚ РїРѕР»РµР·РЅРѕР№ РЅР°РіСЂСѓР·РєРё
РљР°Р¶РґС‹Р№ Р·Р°РїСЂРѕСЃ СЃРѕРґРµСЂР¶РёС‚ `Content-Type: application/json` Рё РІС‹РіР»СЏРґРёС‚ С‚Р°Рє:

```json
{
  "event": "issued",
  "case_number": "CASE-20251118-ABCD",
  "status": "active",
  "mode": "auto",
  "executor": "site",
  "comment": "Mute Р·Р° С‚РѕРєСЃРёС‡РЅРѕСЃС‚СЊ",
  "subject": {"id": 42, "name": "Player"},
  "judge": {"id": 7, "name": "Moderator"},
  "actions": [
    {
      "type": "mute",
      "metric": null,
      "delta": null,
      "duration_minutes": 180,
      "status": "awaiting_revert"
    },
    {
      "type": "metric",
      "metric": "socialrating",
      "delta": -30,
      "duration_minutes": null,
      "status": "applied"
    }
  ]
}
```

- `case_number` вЂ” СЃС‚Р°Р±РёР»СЊРЅС‹Р№ РёРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ РІРёРґР° `CASE-YYYYMMDD-HHMMSS-RAND`.
- `status` вЂ” РѕРґРЅРѕ РёР· Р·РЅР°С‡РµРЅРёР№ `active`, `awaiting_revert`, `completed`, `cancelled`, `revoked`.
- `mode` вЂ” `auto` (С€Р°Р±Р»РѕРЅ) РёР»Рё `manual`.
- `executor` вЂ” РєР°РЅР°Р», РѕС‚ РёРјРµРЅРё РєРѕС‚РѕСЂРѕРіРѕ РёСЃРїРѕР»РЅРµРЅРѕ РЅР°РєР°Р·Р°РЅРёРµ (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ `site`).
- `subject` Рё `judge` СЃРѕРґРµСЂР¶Р°С‚ ID Рё С‚РµРєСѓС‰РёР№ РЅРёРєРЅРµР№Рј РёР· Azuriom.
- `actions[*]`:
  - `type`: `ban`, `mute`, `metric`, `role`, `note`.
  - `metric`: РєР»СЋС‡ РјРµС‚СЂРёРєРё (`socialrating`, `activity`, `coins`, `money`) РґР»СЏ `metric`-РґРµР№СЃС‚РІРёР№, РёРЅР°С‡Рµ `null`.
  - `delta`: С‡РёСЃР»РѕРІРѕРµ РёР·РјРµРЅРµРЅРёРµ РјРµС‚СЂРёРєРё.
  - `duration_minutes`: РґР»РёС‚РµР»СЊРЅРѕСЃС‚СЊ РІСЂРµРјРµРЅРЅС‹С… РЅР°РєР°Р·Р°РЅРёР№ (РјРѕР¶РµС‚ Р±С‹С‚СЊ `null`).
  - `status`: `applied`, `awaiting_revert` РёР»Рё `reverted`.

РџСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё С…СЂР°РЅРёС‚СЊ РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ РїРѕР»СЏ Р»РѕРіРёРєРё (РЅР°РїСЂРёРјРµСЂ, РїСЂРёРІСЏР·РєРё Рє Discord) РґРѕР±Р°РІР»СЏР№С‚Рµ РёС… РЅР° СЃРІРѕРµР№ СЃС‚РѕСЂРѕРЅРµ вЂ” JSON, РєРѕС‚РѕСЂС‹Р№ РїСЂРёСЃС‹Р»Р°РµС‚ РЎСѓРґ, РѕСЃС‚Р°С‘С‚СЃСЏ СЃС‚Р°Р±РёР»СЊРЅС‹Рј Рё РѕР±СЂР°С‚РЅРѕ СЃРѕРІРјРµСЃС‚РёРјС‹Рј.

## РџРѕРґРїРёСЃСЊ Рё Р±РµР·РѕРїР°СЃРЅРѕСЃС‚СЊ
- Р•СЃР»Рё Р·Р°РїРѕР»РЅРµРЅРѕ РїРѕР»Рµ В«РЎРµРєСЂРµС‚В», РєР°Р¶РґРѕРµ СЃРѕРѕР±С‰РµРЅРёРµ РїРѕР»СѓС‡Р°РµС‚ Р·Р°РіРѕР»РѕРІРѕРє `X-Court-Signature` СЃРѕ СЃС‚СЂРѕРєРѕР№ HMAC-SHA256 РѕС‚ В«СЃС‹СЂРѕРіРѕВ» JSON-С‚РµР»Р°. РџСЂРёРјРµСЂ РїСЂРѕРІРµСЂРєРё РЅР° СЃС‚РѕСЂРѕРЅРµ РїРѕР»СѓС‡Р°С‚РµР»СЏ:
  ```php
  $expected = hash_hmac('sha256', $rawBody, $sharedSecret);
  if (! hash_equals($expected, $request->header('X-Court-Signature'))) {
      abort(401, 'invalid signature');
  }
  ```
- Р РµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ РѕРіСЂР°РЅРёС‡РёРІР°С‚СЊ РІРµР±С…СѓРєРё РїРѕ IP/ASN РЅР° СЃС‚РѕСЂРѕРЅРµ РїСЂРёРЅРёРјР°СЋС‰РµРіРѕ СЃРµСЂРІРёСЃР° Рё СЂР°Р±РѕС‚Р°С‚СЊ С‚РѕР»СЊРєРѕ РїРѕ HTTPS.
- Р”РµСЂР¶Р° СЃРµРєСЂРµС‚ РїСѓСЃС‚С‹Рј, РІС‹ РїРѕР»СѓС‡Р°РµС‚Рµ РѕС‚РєСЂС‹С‚С‹Р№ СЌРЅРґРїРѕРёРЅС‚: РёСЃРїРѕР»СЊР·СѓР№С‚Рµ СЌС‚Рѕ С‚РѕР»СЊРєРѕ РґР»СЏ РІРЅСѓС‚СЂРµРЅРЅРёС… СЃРµС‚РµР№.

## РћС‡РµСЂРµРґСЊ Рё СЂРµС‚СЂР°Рё
1. РџСЂРё РЅР°СЃС‚СѓРїР»РµРЅРёРё СЃРѕР±С‹С‚РёСЏ `DispatchCourtWebhooks` СЃРѕР·РґР°С‘С‚ Р·Р°РїРёСЃРё РІ С‚Р°Р±Р»РёС†Рµ `socialprofile_court_webhook_deliveries` (СЃС‚Р°С‚СѓСЃ `pending`, СЃС‡РµС‚С‡РёРє РїРѕРїС‹С‚РѕРє = 0). Р•СЃР»Рё СЃРїРёСЃРѕРє СЃРѕР±С‹С‚РёР№ Сѓ С‚РѕС‡РєРё РЅРµ РїСѓСЃС‚РѕР№, РѕС‚С„РёР»СЊС‚СЂРѕРІС‹РІР°СЋС‚СЃСЏ РІСЃРµ РѕСЃС‚Р°Р»СЊРЅС‹Рµ.
2. РљРѕРјР°РЅРґР° `php artisan socialprofile:court:tick` (СЂРµРіРёСЃС‚СЂРёСЂСѓРµС‚СЃСЏ РІ СЂР°СЃРїРёСЃР°РЅРёРё РєР°Р¶РґС‹Рµ 5 РјРёРЅСѓС‚) РІС‹Р·С‹РІР°РµС‚ `WebhookDispatcher`, РєРѕС‚РѕСЂС‹Р№:
   - Р’С‹Р±РёСЂР°РµС‚ РґРѕ 25 Р·Р°РїРёСЃРµР№ СЃРѕ СЃС‚Р°С‚СѓСЃРѕРј `pending` Рё РЅР°СЃС‚СѓРїРёРІС€РёРј `next_attempt_at`.
   - РћС‚РїСЂР°РІР»СЏРµС‚ `POST` СЃ С‚Р°Р№РјР°СѓС‚РѕРј 10 СЃРµРєСѓРЅРґ. РћС‚РІРµС‚ СЃРѕС…СЂР°РЅСЏРµС‚СЃСЏ РІ РїРѕР»СЏС… `response_code` Рё `response_body` (СѓСЃРµС‡РµРЅРѕ РґРѕ 4096 СЃРёРјРІРѕР»РѕРІ).
   - Р•СЃР»Рё РїРѕР»СѓС‡РµРЅ HTTP 2xx, СЃС‚Р°С‚СѓСЃ РјРµРЅСЏРµС‚СЃСЏ РЅР° `sent`. Р’ РѕСЃС‚Р°Р»СЊРЅС‹С… СЃР»СѓС‡Р°СЏС… СЃС‚Р°С‚СѓСЃ РѕСЃС‚Р°С‘С‚СЃСЏ `pending`, РёРЅРєСЂРµРјРµРЅС‚РёСЂСѓРµС‚СЃСЏ `attempts` Рё РІС‹СЃС‚Р°РІР»СЏРµС‚СЃСЏ `next_attempt_at = now() + retry_after_seconds`.
   - РџРѕСЃР»Рµ `max_attempts` (Р·РЅР°С‡РµРЅРёСЏ Р±РµСЂСѓС‚СЃСЏ РёР· `config/court.php`, СЃРµРєС†РёСЏ `webhook`) СЃС‚Р°С‚СѓСЃ РїРµСЂРµРєР»СЋС‡Р°РµС‚СЃСЏ РЅР° `failed`, С‚РµРєСЃС‚ РѕС€РёР±РєРё РїРёС€РµС‚СЃСЏ РІ РїРѕР»Рµ `error`.
3. РЈРґР°Р»РµРЅРёРµ С‚РѕС‡РєРё РЅРµ РѕС‡РёС‰Р°РµС‚ РёСЃС‚РѕСЂРёСЋ РґРѕСЃС‚Р°РІРѕРє вЂ” РёСЃРїРѕР»СЊР·СѓР№С‚Рµ РµС‘ РґР»СЏ Р°СѓРґРёС‚Р°, С‡С‚РѕР±С‹ РїРѕРЅСЏС‚СЊ, С‡С‚Рѕ РёРјРµРЅРЅРѕ РѕС‚РїСЂР°РІР»СЏР»РѕСЃСЊ Рё РєР°РєРёРµ РѕС‚РІРµС‚С‹ РІРµСЂРЅСѓР»Р° С†РµР»СЊ.

> Р—РЅР°С‡РµРЅРёСЏ РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ: `retry_after_seconds = 120`, `max_attempts = 5`. РР·РјРµРЅРёС‚Рµ РёС… РІ `config/court.php`, РµСЃР»Рё РЅСѓР¶РЅР° Р±РѕР»РµРµ Р°РіСЂРµСЃСЃРёРІРЅР°СЏ РёР»Рё РєРѕРЅСЃРµСЂРІР°С‚РёРІРЅР°СЏ РїРѕР»РёС‚РёРєР° РїРѕРІС‚РѕСЂР°.

## Р”РёР°РіРЅРѕСЃС‚РёРєР°
- РџСЂРѕРІРµСЂСЊС‚Рµ РѕС‡РµСЂРµРґСЊ: `select status, attempts, error from socialprofile_court_webhook_deliveries order by id desc limit 10;` вЂ” С‚Р°Рє РІС‹ СѓРІРёРґРёС‚Рµ, С‡С‚Рѕ РјРµС€Р°РµС‚ РѕС‚РїСЂР°РІРєРµ.
- РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ СЂР°СЃРїРёСЃР°РЅРёРµ СЂРµР°Р»СЊРЅРѕ РІС‹Р·С‹РІР°РµС‚ `socialprofile:court:tick`. Р•СЃР»Рё cron РІС‹РєР»СЋС‡РµРЅ, РІРµР±С…СѓРєРё РѕСЃС‚Р°РЅСѓС‚СЃСЏ РІ СЃС‚Р°С‚СѓСЃРµ `pending`.
- РќР°Р±Р»СЋРґР°Р№С‚Рµ Р·Р° HTTP-РѕС‚РІРµС‚Р°РјРё С†РµР»Рё. Р’РµР±С…СѓРє СЃС‡РёС‚Р°РµС‚СЃСЏ СѓСЃРїРµС€РЅС‹Рј С‚РѕР»СЊРєРѕ РїСЂРё СЃС‚Р°С‚СѓСЃРµ 2xx; 3xx/4xx/5xx Р±СѓРґСѓС‚ СЂРµС‚СЂР°РёС‚СЊСЃСЏ, Р° С‚РµР»Рѕ РѕС‚РІРµС‚Р° РїРѕРїР°РґС‘С‚ РІ `response_body` (РјРѕР¶РЅРѕ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РґР»СЏ РґРёР°РіРЅРѕСЃС‚РёРєРё).
- РџСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РІРѕСЃРїСЂРѕРёР·РІРµСЃС‚Рё Р·Р°РїСЂРѕСЃ РІСЂСѓС‡РЅСѓСЋ РІРѕР·СЊРјРёС‚Рµ `тело запроса` РёР· С‚Р°Р±Р»РёС†С‹ РґРѕСЃС‚Р°РІРѕРє Рё РѕС‚РїСЂР°РІСЊС‚Рµ РµРіРѕ С‡РµСЂРµР· `curl`/Postman РЅР° С‚Сѓ Р¶Рµ С‚РѕС‡РєСѓ, С‡С‚Рѕ СѓРєР°Р·Р°РЅР° РІ `url`.

## Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ РјР°С‚РµСЂРёР°Р»С‹
- `docs/API-court.md` вЂ” РїРѕР»РЅС‹Р№ СЃРїРёСЃРѕРє API-СЌРЅРґРїРѕРёРЅС‚РѕРІ + РєРѕСЂРѕС‚РєРѕРµ РѕРїРёСЃР°РЅРёРµ РІРµР±С…СѓРєР°.
- `docs/INTEGRATION-court.md` вЂ” Р¶РёР·РЅРµРЅРЅС‹Р№ С†РёРєР» РѕС‡РµСЂРµРґРё Рё РїСЂРёРјРµСЂС‹ С‚РѕРіРѕ, РєР°Рє РїРѕРґРєР»СЋС‡Р°С‚СЊ РІРЅРµС€РЅРёРµ СЃРµСЂРІРёСЃС‹.
- `docs/SECURITY-court.md` вЂ” СЃРІРѕРґ РїСЂР°РІ РґРѕСЃС‚СѓРїР° Рё Р»РёРјРёС‚РѕРІ, РєРѕС‚РѕСЂС‹Рµ С‚Р°РєР¶Рµ РІР°Р¶РЅС‹ РґР»СЏ Р±РµР·РѕРїР°СЃРЅРѕР№ СЂР°Р±РѕС‚С‹ РІРµР±С…СѓРєРѕРІ.
