# Точки вебхуков для Суда

Документ описывает, как настроить и эксплуатировать вебхуки в разделе **Admin → Social Profile → Court → Settings → Точки вебхуков**. Эта страница дополняет краткие заметки из `docs/USAGE-court.md` и предназначена для тех, кто подключает внешние интеграции или следит за доставкой уведомлений.

## Доступ и навигация
- Права: `social.court.webhooks` (редактирование списка точек) и `social.court.manage_settings` (доступ к остальным настройкам раздела).
- Путь: **Admin → Court → Settings → Вебхуки**. Левая колонка содержит общие настройки суда, правая — форму создания точки и список уже созданных.
- При создании записи флаг `is_active` всегда включён. При необходимости временно выключить вебхук, удалите точку из интерфейса или обновите запись напрямую в БД.

## Поля точки
| Поле | Назначение |
|------|------------|
| `Название` | Человекочитаемый тег, который используется только внутри панели (виден в списке точек и логах). |
| `URL` | Конечный адрес, который принимает `POST`-запросы в формате JSON. Обязательно должна быть публично доступная HTTPS-точка. |
| `Секрет` | Необязательная строка до 255 символов. При заполнении система будет подписывать каждую доставку HMAC-подписью. |
| `События` | Множественный выбор: `issued`, `reverted`, `updated`. Пустой список = подписка на все события. |

> Используйте отдельные URL для разных систем (Discord-бот, SIEM, Minecraft-адаптер), чтобы упрощать отладку и ограничивать права каждой интеграции.

## События
| Событие | Комментарий |
|---------|-------------|
| `issued` | Отправляется сразу после создания дела (`CourtService::storeDecision`). |
| `updated` | Зарезервировано под будущие правки дел (например, продление или изменение комментария). |
| `reverted` | Используется при откате действий (по расписанию `socialprofile:court:tick` или вручную). |

Даже если выбран только один тип события, запись остаётся в очереди доставок — остальные фильтруются ещё до постановки в очередь, что защищает внешние системы от лишних вызовов.

## Формат полезной нагрузки
Каждый запрос содержит `Content-Type: application/json` и выглядит так:

```json
{
  "event": "issued",
  "case_number": "CASE-20251118-ABCD",
  "status": "active",
  "mode": "auto",
  "executor": "site",
  "comment": "Mute за токсичность",
  "subject": {"id": 42, "name": "Player"},
  "judge": {"id": 7, "name": "Moderator"},
  "actions": [
    {
      "type": "mute",
      "metric": null,
      "delta": null,
      "duration_minutes": 180,
      "status": "awaiting_revert"
    },
    {
      "type": "metric",
      "metric": "socialrating",
      "delta": -30,
      "duration_minutes": null,
      "status": "applied"
    }
  ]
}
```

- `case_number` — стабильный идентификатор вида `CASE-YYYYMMDD-HHMMSS-RAND`.
- `status` — одно из значений `active`, `awaiting_revert`, `completed`, `cancelled`, `revoked`.
- `mode` — `auto` (шаблон) или `manual`.
- `executor` — канал, от имени которого исполнено наказание (по умолчанию `site`).
- `subject` и `judge` содержат ID и текущий никнейм из Azuriom.
- `actions[*]`:
  - `type`: `ban`, `mute`, `metric`, `role`, `note`.
  - `metric`: ключ метрики (`socialrating`, `activity`, `coins`, `money`) для `metric`-действий, иначе `null`.
  - `delta`: числовое изменение метрики.
  - `duration_minutes`: длительность временных наказаний (может быть `null`).
  - `status`: `applied`, `awaiting_revert` или `reverted`.

При необходимости хранить дополнительные поля логики (например, привязки к Discord) добавляйте их на своей стороне — JSON, который присылает Суд, остаётся стабильным и обратно совместимым.

## Подпись и безопасность
- Если заполнено поле «Секрет», каждое сообщение получает заголовок `X-Court-Signature` со строкой HMAC-SHA256 от «сырого» JSON-тела. Пример проверки на стороне получателя:
  ```php
  $expected = hash_hmac('sha256', $rawBody, $sharedSecret);
  if (! hash_equals($expected, $request->header('X-Court-Signature'))) {
      abort(401, 'invalid signature');
  }
  ```
- Рекомендуется ограничивать вебхуки по IP/ASN на стороне принимающего сервиса и работать только по HTTPS.
- Держа секрет пустым, вы получаете открытый эндпоинт: используйте это только для внутренних сетей.

## Очередь и ретраи
1. При наступлении события `DispatchCourtWebhooks` создаёт записи в таблице `socialprofile_court_webhook_deliveries` (статус `pending`, счетчик попыток = 0). Если список событий у точки не пустой, отфильтровываются все остальные.
2. Команда `php artisan socialprofile:court:tick` (регистрируется в расписании каждые 5 минут) вызывает `WebhookDispatcher`, который:
   - Выбирает до 25 записей со статусом `pending` и наступившим `next_attempt_at`.
   - Отправляет `POST` с таймаутом 10 секунд. Ответ сохраняется в полях `response_code` и `response_body` (усечено до 4096 символов).
   - Если получен HTTP 2xx, статус меняется на `sent`. В остальных случаях статус остаётся `pending`, инкрементируется `attempts` и выставляется `next_attempt_at = now() + retry_after_seconds`.
   - После `max_attempts` (значения берутся из `config/court.php`, секция `webhook`) статус переключается на `failed`, текст ошибки пишется в поле `error`.
3. Удаление точки не очищает историю доставок — используйте её для аудита, чтобы понять, что именно отправлялось и какие ответы вернула цель.

> Значения по умолчанию: `retry_after_seconds = 120`, `max_attempts = 5`. Измените их в `config/court.php`, если нужна более агрессивная или консервативная политика повтора.

## Диагностика
- Проверьте очередь: `select status, attempts, error from socialprofile_court_webhook_deliveries order by id desc limit 10;` — так вы увидите, что мешает отправке.
- Убедитесь, что расписание реально вызывает `socialprofile:court:tick`. Если cron выключен, вебхуки останутся в статусе `pending`.
- Наблюдайте за HTTP-ответами цели. Вебхук считается успешным только при статусе 2xx; 3xx/4xx/5xx будут ретраиться, а тело ответа попадёт в `response_body` (можно использовать для диагностики).
- При необходимости воспроизвести запрос вручную возьмите `payload` из таблицы доставок и отправьте его через `curl`/Postman на ту же точку, что указана в `url`.

## Дополнительные материалы
- `docs/API-court.md` — полный список API-эндпоинтов + короткое описание вебхука.
- `docs/INTEGRATION-court.md` — жизненный цикл очереди и примеры того, как подключать внешние сервисы.
- `docs/SECURITY-court.md` — свод прав доступа и лимитов, которые также важны для безопасной работы вебхуков.
