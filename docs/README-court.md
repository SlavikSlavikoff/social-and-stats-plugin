# Обзор модуля Court

## Назначение

Модуль «Суд» формализует полный жизненный цикл модераторских решений внутри плагина Inspirato для Azuriom. Он даёт настраиваемые шаблоны наказаний, ручные решения, историю аудита, слушателей, уведомления по вебхукам и отказоустойчивый планировщик, который способен откатывать ротацию ролей (ban/mute).

## Базовые сущности

- **Дело** (`CourtCase`) — запись о деле: игрок, судья, канал исполнителя (пока `site`), выбранный шаблон (опционально) и текущий статус.
- **Действие** (`CourtAction`) — конкретный эффект внутри дела (изменение метрик, бан, мут, смена роли, заметка). Может планировать автоматический откат.
- **Шаблон** — заранее заданный набор данных с дельтами, длительностями бан/мут и базовым комментарием. Хранится в `socialprofile_court_templates` и редактируется из админки.
- **Задача отката** — отложенное задание, описывающее, что восстановить после истечения таймера.
- **Журнал** — история по каждому делу, поддерживаемая БД и вебхуками.

## Жизненный цикл и статусы

1. Судья открывает `/court/judge` (право `social.court.judge`).
2. Выбирает режим **Auto** (шаблон) или **Manual**.
3. Сервис проверяет лимиты, настройки ролей для бан/мут и создаёт дело со статусом `active`.
4. Каждое действие применяется сразу; смена ролей сохраняет снапшот и при необходимости ставит задачи на откат.
5. Планировщик (`socialprofile:court:tick`) следит за `socialprofile_court_revert_jobs` и `socialprofile_court_webhook_deliveries`, чтобы вернуть роли и доставить вебхуки.
6. Переходы статусов:
   - `issued` → `active` после записи действий;
   - `awaiting_revert`, если есть таймеры;
   - `completed` после отката всех действий;
   - `cancelled`/`revoked` — сценарии будущих отмен.

## Таблицы БД

| Таблица | Назначение |
|--------|------------|
| `socialprofile_court_templates` | Настраиваемые шаблоны с набором данных и лимитами |
| `socialprofile_court_cases` | Метаданные дела, статусы, связи; индексы по `user_id`, `judge_id`, `status`, `created_at`, `expires_at` |
| `socialprofile_court_actions` | Действия (бан/мут/метрики/роль) и таймеры |
| `socialprofile_court_state_snapshots` | Сохранённые предыдущие роли для безопасного отката |
| `socialprofile_court_revert_jobs` | Очередь планировщика для истечений |
| `socialprofile_court_logs` | Подробная история | 
| `socialprofile_court_attachments` | Ссылки на доказательства |
| `socialprofile_court_webhooks` / `_deliveries` | Конфигурация вебхуков и очередь доставок |

## UI и права

- **/court/judge** — рабочее место судьи. Доступно авторизованным пользователям с правом `social.court.judge`, работает вне админки и включает оба режима плюс список дел.
- **Admin → Court** — входная точка с поиском и ссылкой на архив.
- **Admin → Court → Archive** — пагинация дел (право `social.court.archive`).
- **Admin → Court → Settings** — роли, лимиты, вебхуки (права `social.court.manage_settings` / `social.court.webhooks`).
- **Admin → Court → Templates** — отдельная страница редактирования шаблонов и кнопка «Refresh from config».
- **/court** — публичный список решений (чтение при праве `social.court.archive`).

## Управление шаблонами

- Шаблоны живут в БД (`socialprofile_court_templates`) и редактируются через новую страницу админки.
- В форме доступны поля имени, key, базового комментария, JSON-набора данных и флага активности.
- Кнопка обновления сбрасывает `setting('socialprofile_court_templates_seeded')` и повторно импортирует данные из `config/court.php`.
- Удаление шаблона блокирует только будущие авто-дела; существующие записи сохраняют `template_id` для аудита.

## Планировщик и слушатели

- Зарегистрирована команда `RunCourtScheduler`, запускаемая каждые 5 минут.
- Событие `CourtDecisionChanged` уведомляет:
  - `DispatchCourtWebhooks` — ставит доставки в очередь и повторяет с экспоненциальной задержкой;
  - `ForwardCourtDecisionToIntegrations` — заглушка под интеграции (см. `docs/TODO.md#listeners`).

## Стратегия тестирования

- Unit-тесты — `CourtServiceTest` проверяет дельты метрик и таймеры.
- Feature-тесты — формы админки, JSON API, публичные страницы, логика отката.
- Policy-тесты — `tests/Feature/Http/Web/CourtControllerTest.php`.
- Тесты планировщика — `CourtSchedulerTest` подтверждает идемпотентность cron.

## Следующие шаги

- Подключить реальные интеграции к placeholder-слушателю, когда будут готовы эндпоинты Minecraft/ботов.
- Расширить поддержку вложений для загрузки файлов, а не только URL.
